# Security Review Report - Task 011 & 013

**Status**: Pending
**Generated**: 2026-02-06 (UTC)
**Total Issues**: 5
**Reviewed Files**: 8 files
**Commits Audited**: af98800 (Task 011), 9475fc8 (Task 013)

---

âš ï¸ **AI ì—ì´ì „íŠ¸ë¥¼ ìœ„í•œ ì¤‘ìš” ì§€ì¹¨**:
1. ê° ì´ìŠˆë¥¼ ìˆ˜ì •í•œ í›„ ì¦‰ì‹œ í•´ë‹¹ ì²´í¬ë°•ìŠ¤ë¥¼ ì²´í¬í•˜ì„¸ìš”
2. ëª¨ë“  ì´ìŠˆê°€ í•´ê²°ë˜ë©´ Statusë¥¼ "âœ… Complete"ë¡œ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”
3. ì™„ë£Œëœ í•­ëª©ì„ ì²´í¬í•˜ì§€ ì•Šê³  ì´ ë¦¬í¬íŠ¸ë¥¼ ë– ë‚˜ì§€ ë§ˆì„¸ìš”

---

## ğŸ“Š Summary

This security audit reviews Task 011 (Invoice Detail Page Data Integration) and Task 013 (PDF Document Component) for OWASP Top 10 2025 compliance. The audit focuses on input validation, error message sanitization, XSS prevention, external resource security, and proper error handling.

**Overall Assessment**: **GOOD** - The implementation demonstrates strong security awareness with comprehensive input validation, error sanitization, and XSS prevention. However, there are areas requiring attention around external URL validation and CSP headers for font loading.

| Severity | Count |
|----------|-------|
| ğŸ”´ Critical | 0 |
| ğŸŸ  High | 2 |
| ğŸŸ¡ Medium | 2 |
| ğŸŸ¢ Low | 1 |

---

## ğŸš¨ Critical Issues

> ë²„ê·¸, ë³´ì•ˆ ì·¨ì•½ì  ë“± ë°˜ë“œì‹œ ìˆ˜ì •í•´ì•¼ í•˜ëŠ” ì´ìŠˆ

**No critical issues found.** âœ…

---

## âš ï¸ High Severity Issues

> ìœ ì§€ë³´ìˆ˜ì„± ë˜ëŠ” ë³´ì•ˆì— ì˜í–¥ì„ ì£¼ëŠ” ì¤‘ìš”í•œ ì´ìŠˆ

### H-1: External Image URL Injection Risk (SSRF/Content Injection)

**OWASP Category**: A10 - Server-Side Request Forgery (SSRF)

**Location**:
- `app/presentation/components/pdf/invoice-pdf-document.tsx:39`
- `app/presentation/components/invoice/invoice-header.tsx:31`

**Problem**:
The `companyInfo.logo_url` is rendered directly in both web view and PDF without URL validation or allowlist checking. While Zod validates URL format at the schema level, there's no runtime protection against:
- Data URIs with malicious payloads (`data:text/html,<script>`)
- Internal network URLs (SSRF: `http://169.254.169.254/latest/meta-data/`)
- Non-HTTPS URLs in production

**Impact**:
- **SSRF Risk**: Attacker with Notion database access could inject URLs pointing to internal metadata services
- **Content Injection**: Data URIs could be used to embed malicious content
- **Mixed Content**: HTTP URLs in HTTPS context could trigger browser warnings

**Evidence**:
```tsx
// app/presentation/components/pdf/invoice-pdf-document.tsx:38-39
{companyInfo.logo_url && (
  <Image src={companyInfo.logo_url} style={pdfStyles.logo} />
)}

// app/presentation/components/invoice/invoice-header.tsx:29-31
{companyInfo.logo_url && (
  <img
    src={companyInfo.logo_url}
    alt={companyInfo.company_name}
    className="h-12 w-auto object-contain"
  />
)}
```

**Solution**:
1. Create URL validation utility with allowlist:
```typescript
// app/infrastructure/utils/url-validator.ts
const ALLOWED_IMAGE_DOMAINS = [
  'images.unsplash.com',
  'cdn.example.com',
  's3.amazonaws.com',
  'cloudflare-ipfs.com'
];

export const validateImageUrl = (url: string): boolean => {
  try {
    const parsed = new URL(url);

    // Only HTTPS in production
    if (import.meta.env.PROD && parsed.protocol !== 'https:') {
      return false;
    }

    // Block data URIs
    if (parsed.protocol === 'data:') {
      return false;
    }

    // Block private/internal IPs
    const hostname = parsed.hostname;
    if (
      hostname === 'localhost' ||
      hostname === '127.0.0.1' ||
      hostname.startsWith('192.168.') ||
      hostname.startsWith('10.') ||
      hostname.startsWith('172.16.')
    ) {
      return false;
    }

    // Check domain allowlist
    return ALLOWED_IMAGE_DOMAINS.some(domain =>
      hostname === domain || hostname.endsWith(`.${domain}`)
    );
  } catch {
    return false;
  }
};
```

2. Apply validation in mapper:
```typescript
// app/infrastructure/external/notion/notion.mapper.ts:237
logo_url: logoUrl && validateImageUrl(logoUrl) ? logoUrl : undefined,
```

**References**:
- [OWASP SSRF Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html)
- [Content Security Policy - img-src](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/img-src)

---

### H-2: Missing Content Security Policy for External Font Loading

**OWASP Category**: A05 - Security Misconfiguration

**Location**: `app/presentation/components/pdf/pdf-fonts.ts:20-27`

**Problem**:
Google Fonts CDN URLs are hardcoded without CSP configuration. If the CDN is compromised or performs a redirect attack, malicious font files could be loaded. Additionally, there's no Subresource Integrity (SRI) validation.

**Impact**:
- **Supply Chain Attack**: Compromised CDN could serve malicious font files
- **Man-in-the-Middle**: Without SRI, MITM attacks could inject malicious content
- **Privacy Leakage**: External font requests leak user IP addresses to Google

**Evidence**:
```typescript
// app/presentation/components/pdf/pdf-fonts.ts:20-27
{
  src: "https://fonts.gstatic.com/s/notosanskr/v36/PbyxFmXiEBPT4ITbgNA5Cgms3VYcOA-vvnIzzuoyeLTq8H4hfeE.ttf",
  fontWeight: 400,
},
{
  src: "https://fonts.gstatic.com/s/notosanskr/v36/PbyxFmXiEBPT4ITbgNA5Cgms3VYcOA-vvnIzzuoyjbTq8H4hfeE.ttf",
  fontWeight: 700,
}
```

**Solution**:
1. Add CSP header in root.tsx or middleware:
```typescript
// app/root.tsx - Add to headers function
export const headers: HeadersFunction = () => ({
  "Content-Security-Policy":
    "default-src 'self'; " +
    "font-src 'self' https://fonts.gstatic.com; " +
    "img-src 'self' https:; " +
    "script-src 'self' 'unsafe-inline'; " +
    "style-src 'self' 'unsafe-inline';"
});
```

2. Consider self-hosting fonts:
```bash
# Download fonts to public/fonts/
# Update pdf-fonts.ts to use local paths
src: "/fonts/NotoSansKR-Regular.ttf"
```

3. Document privacy implications in PRIVACY.md

**References**:
- [OWASP CSP Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html)
- [Google Fonts Privacy Concerns](https://www.cookiestatus.com/google-fonts/)

---

## ğŸ’¡ Medium Severity Issues

> ì½”ë“œ í’ˆì§ˆ ì´ìŠˆ, ì ì¬ì  ë¬¸ì œ

### M-1: Missing Rate Limiting on Invoice Detail Endpoint

**OWASP Category**: A04 - Insecure Design

**Location**: `app/presentation/routes/invoices/$invoiceId.tsx:72-104`

**Problem**:
The loader function has no rate limiting, allowing unlimited requests to enumerate invoice IDs or perform DoS attacks. While Zod validation prevents injection, there's no throttling mechanism.

**Impact**:
- **Invoice ID Enumeration**: Attackers can brute-force valid invoice IDs (32-char hex = 16^32 combinations, but patterns may exist)
- **Denial of Service**: Rapid requests could exhaust Notion API quota
- **Cost Escalation**: Excessive API calls increase Cloudflare/Notion costs

**Evidence**:
```typescript
// app/presentation/routes/invoices/$invoiceId.tsx:72-104
export const loader = async ({ params, context }: Route.LoaderArgs) => {
  // No rate limiting check
  const parseResult = invoiceIdSchema.safeParse(params.invoiceId);
  // ... rest of loader
};
```

**Solution**:
Leverage existing KV-based rate limiting infrastructure (from Task 009):

```typescript
// app/presentation/routes/invoices/$invoiceId.tsx
import { checkRateLimit } from '~/infrastructure/cache/rate-limiter';

export const loader = async ({ params, context, request }: Route.LoaderArgs) => {
  // Rate limit: 10 requests per minute per IP
  const clientIP = request.headers.get('CF-Connecting-IP') || 'unknown';
  const rateLimitKey = `detail:${clientIP}`;

  try {
    await checkRateLimit(context.env.INVOICE_CACHE, rateLimitKey, {
      maxRequests: 10,
      windowSeconds: 60
    });
  } catch (error) {
    if (error instanceof RateLimitExceededError) {
      throw new Response('Too many requests', {
        status: 429,
        headers: { 'Retry-After': '60' }
      });
    }
  }

  // ... rest of loader
};
```

**References**:
- [OWASP Rate Limiting Guide](https://cheatsheetseries.owasp.org/cheatsheets/Denial_of_Service_Cheat_Sheet.html#rate-limiting)
- [Cloudflare Rate Limiting](https://developers.cloudflare.com/workers/runtime-apis/bindings/rate-limit/)

---

### M-2: Error Message Information Disclosure (Development Mode)

**OWASP Category**: A09 - Security Logging and Monitoring Failures

**Location**: `app/presentation/routes/invoices/$invoiceId.tsx:99-102`

**Problem**:
While `sanitizeErrorMessage()` is correctly applied, the console.error log at line 101 still outputs the sanitized message. In development mode, detailed error messages including sanitized patterns like `[DATABASE_ID_REDACTED]` could reveal system architecture.

**Impact**:
- **Information Leakage**: Console logs expose error patterns and system structure
- **DEV/PROD Parity**: Development mode may leak more info than production
- **Debugging Trail**: Error logs could map internal architecture

**Evidence**:
```typescript
// app/presentation/routes/invoices/$invoiceId.tsx:97-103
const message =
  error instanceof Error
    ? sanitizeErrorMessage(error.message)
    : "Failed to load invoice detail";
console.error("[InvoiceDetail Loader]", message); // âš ï¸ Still logs sanitized patterns
throw new Response(message, { status: 500 });
```

**Solution**:
1. Use conditional logging with environment check:
```typescript
const message =
  error instanceof Error
    ? sanitizeErrorMessage(error.message)
    : "Failed to load invoice detail";

// Only log in development
if (import.meta.env.DEV) {
  console.error("[InvoiceDetail Loader]", message);
}

// Always throw generic message to client
throw new Response("Failed to load invoice detail", { status: 500 });
```

2. Implement structured logging for production:
```typescript
// app/infrastructure/logging/logger.ts
export const logError = (context: string, error: unknown) => {
  if (import.meta.env.PROD) {
    // Send to monitoring service (e.g., Sentry, Datadog)
    captureException(error, { tags: { context } });
  } else {
    console.error(`[${context}]`, error);
  }
};
```

**References**:
- [OWASP Logging Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html)

---

## ğŸŸ¢ Low Severity Issues

> ìŠ¤íƒ€ì¼ ì œì•ˆ, ì‚¬ì†Œí•œ ê°œì„ 

### L-1: Missing Input Validation Documentation

**Location**: `app/presentation/routes/invoices/$invoiceId.tsx:29-41`

**Problem**:
The Zod schema for `invoiceIdSchema` lacks JSDoc documentation explaining the validation rationale and security considerations.

**Suggestion**:
Add comprehensive JSDoc:
```typescript
/**
 * invoiceId íŒŒë¼ë¯¸í„° ê²€ì¦ ìŠ¤í‚¤ë§ˆ
 *
 * Security: Validates against injection attacks (XSS, SQL injection, path traversal)
 * Notion í˜ì´ì§€ ID í˜•ì‹: 32ìë¦¬ hex (í•˜ì´í”ˆ í¬í•¨/ë¯¸í¬í•¨)
 *
 * Validation Rules:
 * - Min length: 1 (prevents empty string bypass)
 * - Max length: 100 (prevents DoS via large inputs)
 * - Pattern: /^[a-f0-9-]+$/i (allows only hex chars and hyphens)
 *
 * Blocked Patterns (examples):
 * - XSS: <script>alert('xss')</script>
 * - SQL Injection: '; DROP TABLE invoices;--
 * - Path Traversal: ../../etc/passwd
 *
 * @see __tests__/presentation/routes/invoices/$invoiceId.loader.test.ts
 */
const invoiceIdSchema = z
  .string()
  .min(1, "Invoice ID is required")
  .max(100, "Invoice ID is too long")
  .regex(
    /^[a-f0-9-]+$/i,
    "Invoice ID must contain only hexadecimal characters and hyphens",
  );
```

---

## âœ¨ Positive Aspects

> ì˜ëœ ì  - ê· í˜• ì¡íŒ í”¼ë“œë°±ì„ ìœ„í•´ í•­ìƒ í¬í•¨

- **âœ… Excellent Input Validation (A03 - Injection)**: The Zod schema at `$invoiceId.tsx:34-41` comprehensively validates invoice IDs with regex, length checks, and clear error messages. Test coverage includes XSS, SQL injection, and path traversal attempts.

- **âœ… Proper Error Sanitization (A02 - Cryptographic Failures)**: `sanitizeErrorMessage()` utility successfully removes API keys, database IDs, tokens, and file paths. The implementation includes 16+ sensitive patterns with extensive test coverage.

- **âœ… XSS Prevention by Design (A03 - Injection)**: React 19's automatic escaping is correctly leveraged. No `dangerouslySetInnerHTML` usage detected. All user content (invoice.notes, client_name, descriptions) is rendered as text nodes, making XSS attacks impossible.

- **âœ… Type-Safe Error Handling**: Custom error classes (`InvoiceNotFoundError`, `NotionApiError`) provide type-safe error discrimination, preventing accidental sensitive data exposure.

- **âœ… Comprehensive Test Coverage**: The loader test suite (`$invoiceId.loader.test.ts`) includes 14 test cases covering success paths, 404 errors, input validation edge cases, and error message sanitization. This demonstrates TDD-first approach compliance.

- **âœ… Secure PDF Rendering**: The PDF component uses `@react-pdf/renderer` which generates PDFs server-side (or client-side in this case), avoiding common PDF injection vulnerabilities. No user input is directly interpolated into PDF structure.

- **âœ… No Hardcoded Secrets**: `bun audit` and manual code review confirm zero hardcoded API keys, passwords, or tokens in the audited files.

---

## ğŸ“‹ Recommended Actions

> ìš°ì„ ìˆœìœ„ê°€ ì§€ì •ëœ ë‹¤ìŒ ë‹¨ê³„ ëª©ë¡

### Immediate (Before Production Deploy)

1. **[High]** Implement URL validation with allowlist for `logo_url` (H-1)
2. **[High]** Add Content Security Policy headers for font-src and img-src (H-2)
3. **[Medium]** Integrate rate limiting on detail page loader (M-1)

### Short-term (Next Sprint)

4. **[Medium]** Implement environment-aware logging strategy (M-2)
5. **[Low]** Add JSDoc documentation to validation schemas (L-1)
6. **[Advisory]** Consider self-hosting Google Fonts for privacy compliance (H-2)

### Long-term (Security Hardening)

7. **[Future]** Implement authentication/authorization for invoice access
8. **[Future]** Add audit logging for invoice access attempts
9. **[Future]** Consider implementing signed URLs for invoice sharing

---

## ğŸ”’ OWASP Top 10 2025 Compliance Status

| Category | Status | Notes |
|----------|--------|-------|
| **A01 - Broken Access Control** | âš ï¸ Not Audited | No authentication implemented yet (planned feature) |
| **A02 - Cryptographic Failures** | âœ… Pass | No hardcoded secrets, error sanitization implemented |
| **A03 - Injection** | âœ… Pass | Comprehensive Zod validation, React 19 XSS protection |
| **A04 - Insecure Design** | ğŸŸ¡ Advisory | Missing rate limiting (M-1) |
| **A05 - Security Misconfiguration** | ğŸŸ  Issue | Missing CSP headers (H-2) |
| **A06 - Vulnerable Components** | âš ï¸ Advisory | 2 high-severity npm advisories (transitive dependencies) |
| **A07 - Authentication Failures** | âš ï¸ N/A | Authentication not yet implemented |
| **A08 - Data Integrity Failures** | âœ… Pass | Zod validation ensures data integrity |
| **A09 - Logging Failures** | ğŸŸ¡ Advisory | Console logging needs improvement (M-2) |
| **A10 - SSRF** | ğŸŸ  Issue | Missing URL validation for logo_url (H-1) |

---

## ğŸ“¦ Dependency Vulnerabilities

**Audit Command**: `bun audit --json`

### High Severity Issues (Development Dependencies Only)

1. **@isaacs/brace-expansion** â‰¤5.0.0
   - **CVE**: GHSA-7h2j-956f-4vf2
   - **Severity**: High
   - **Type**: Uncontrolled Resource Consumption (CWE-1333)
   - **Impact**: Development tooling only (shadcn CLI transitive dependency)
   - **Action**: Run `bun update` to patch
   - **Runtime Risk**: âœ… None (not in production bundle)

2. **@modelcontextprotocol/sdk** 1.10.0-1.25.3
   - **CVE**: GHSA-345p-7cg4-v4c7
   - **Severity**: High (CVSS 7.1)
   - **Type**: Cross-client data leak via shared server/transport reuse (CWE-362)
   - **Impact**: Development tooling only (Claude MCP SDK)
   - **Action**: Run `bun update` to patch
   - **Runtime Risk**: âœ… None (not in production bundle)

**Recommendation**: Update dependencies with `bun update` before next deployment.

---

## âœ… Fix Checklist

**í•„ìˆ˜**: ì´ìŠˆë¥¼ ìˆ˜ì •í•œ ì§í›„ ê° ì²´í¬ë°•ìŠ¤ë¥¼ ì²´í¬í•˜ì„¸ìš”.

### High Severity Issues
- [ ] **H-1** `app/presentation/components/pdf/invoice-pdf-document.tsx:39` - Implement URL validation with allowlist for logo_url
- [ ] **H-1** `app/presentation/components/invoice/invoice-header.tsx:31` - Apply same URL validation to web view
- [ ] **H-2** `app/root.tsx` - Add Content-Security-Policy header with font-src allowlist

### Medium Severity Issues
- [ ] **M-1** `app/presentation/routes/invoices/$invoiceId.tsx:72` - Add rate limiting check before validation
- [ ] **M-2** `app/presentation/routes/invoices/$invoiceId.tsx:101` - Implement environment-aware logging

### Low Severity Issues
- [ ] **L-1** `app/presentation/routes/invoices/$invoiceId.tsx:29` - Add JSDoc to invoiceIdSchema

### Dependency Updates
- [ ] Run `bun update` to patch @isaacs/brace-expansion and @modelcontextprotocol/sdk

---

## ğŸ“ Notes

**Security Audit Methodology**:
1. âœ… Dependency vulnerability scan (`bun audit`)
2. âœ… Git diff analysis (commits af98800, 9475fc8)
3. âœ… OWASP Top 10 2025 checklist
4. âœ… Manual code review (8 files)
5. âœ… Test coverage analysis

**Files Reviewed**:
- `app/presentation/routes/invoices/$invoiceId.tsx` (Primary focus)
- `app/presentation/components/pdf/invoice-pdf-document.tsx` (PDF security)
- `app/presentation/components/pdf/pdf-fonts.ts` (External resources)
- `app/presentation/components/pdf/pdf-styles.ts` (Styling only - no security impact)
- `app/presentation/components/invoice/invoice-header.tsx` (Logo rendering)
- `app/presentation/components/invoice/invoice-table.tsx` (Data rendering)
- `app/infrastructure/utils/error-sanitizer.ts` (Security utility - excellent)
- `__tests__/presentation/routes/invoices/$invoiceId.loader.test.ts` (Test coverage)

**Excluded from Audit** (out of scope):
- Authentication/Authorization (not yet implemented)
- Notion API integration security (covered in previous audit - Task 009)
- Infrastructure security (wrangler.toml, Cloudflare Workers config)

ì‹¬ê°ë„ ìˆœì„œëŒ€ë¡œ ì´ìŠˆë¥¼ í•´ê²°í•˜ì„¸ìš” (High > Medium > Low).
ëª¨ë“  ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ë©´ Statusë¥¼ "âœ… Complete"ë¡œ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.

---

*Generated by security-auditor agent*
*Audit Date: 2026-02-06*
*Compliance Framework: OWASP Top 10 2025*
