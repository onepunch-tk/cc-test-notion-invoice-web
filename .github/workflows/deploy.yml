name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
  workflow_dispatch: # 수동 실행 허용

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      deployments: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build project
        run: bun run build

      - name: Remove _redirects file (Cloudflare Workers doesn't need it)
        # React Router 7이 빌드 시 _redirects 파일을 생성할 수 있습니다
        # Cloudflare Workers는 SSR을 사용하므로 _redirects 파일이 필요 없고 무한 루프를 일으킬 수 있습니다
        run: |
          # build 디렉토리와 public 디렉토리에서 _redirects 파일 찾아서 삭제
          find build public -name "_redirects" -type f 2>/dev/null | while read file; do
            echo "Removing $file"
            rm -f "$file"
          done || true
          echo "✓ Checked for _redirects files (removed if found)"

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # 참고: Cloudflare Workers의 환경 변수는 다음 방법 중 하나로 설정해야 합니다:
          # 1. Cloudflare Dashboard → Workers & Pages → jongrogwon-news → Settings → Variables
          # 2. 로컬에서 wrangler secret put 명령 실행 (수동)
          # 
          # 필요한 서버 사이드 환경 변수 (process.env.*):
          # - DATABASE_URL
          # - SUPABASE_URL
          # - SUPABASE_PUBLISHABLE_KEY
          # - SUPABASE_SERVICE_ROLE_KEY
          # - COOKIE_SECRET
          # - SITE_URL
          # 
          # 참고: VITE_* 변수는 빌드 시점에 번들에 포함되므로 Cloudflare Dashboard에 설정할 필요 없습니다

